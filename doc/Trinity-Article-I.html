<!DOCTYPE html><html>

<head>
<meta charset="utf-8">
<title>Trinity-Article-I</title>
<style type="text/css">
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA09pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoMTMuMCAyMDEyMDMwNS5tLjQxNSAyMDEyLzAzLzA1OjIxOjAwOjAwKSAgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUM2NjlDQjI4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUM2NjlDQjM4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5QzY2OUNCMDg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5QzY2OUNCMTg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsQhXeAAAABfSURBVHjaYvz//z8DJYCRUgMYQAbAMBQIAvEqkBQWXI6sHqwHiwG70TTBxGaiWwjCTGgOUgJiF1J8wMRAIUA34B4Q76HUBelAfJYSA0CuMIEaRP8wGIkGMA54bgQIMACAmkXJi0hKJQAAAABJRU5ErkJggg==) no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0;
}

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }
li {
  margin: 0; }
ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0;border-collapse: collapse; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
}
</style>
<style type="text/css">
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #a67f59;
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
</style>
<style type="text/css">
pre.line-numbers {
	position: relative;
	padding-left: 3.8em;
	counter-reset: linenumber;
}

pre.line-numbers > code {
	position: relative;
}

.line-numbers .line-numbers-rows {
	position: absolute;
	pointer-events: none;
	top: 0;
	font-size: 100%;
	left: -3.8em;
	width: 3em; /* works for line-numbers below 1000 lines */
	letter-spacing: -1px;
	border-right: 1px solid #999;

	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	user-select: none;

}

	.line-numbers-rows > span {
		pointer-events: none;
		display: block;
		counter-increment: linenumber;
	}

		.line-numbers-rows > span:before {
			content: counter(linenumber);
			color: #999;
			display: block;
			padding-right: 0.8em;
			text-align: right;
		}
</style>
<style type="text/css">
pre[class*=language-]{position:relative}pre[class*=language-][data-language]::before{content:attr(data-language);color:#000;background-color:#CFCFCF;display:inline-block;position:absolute;top:0;right:0;font-size:.9em;border-radius:0 0 0 5px;padding:0 .5em;text-shadow:none}
</style>
</head>
<body>
<h1 id="toc_0">Docker, Elastic Beanstalk and Git: a useful trinity for agile development?</h1>

<p>By Duncan Rutland, Sr. Solution Architect, Rackspace 2015</p>

<hr>

<h2 id="toc_1">I - Prologue</h2>

<p>You have been assigned the task of writing an enhancement to <em>the project</em>, which you undertake within a feature branch on your laptop (merging frequently from master of course). Reaching a stable point, you do decide to do a final merge, commit and check out how it runs in a local container runtime environment. You type &quot;git commit -m ...&quot; and a hook automatically triggers a new immutable Docker container to be built, local unit tests to be run, and upon success the new container is pushed to your <a href="https://hub.docker.com/">Dockerhub</a> repository and spun up in the Docker host running on your laptop. A quick visual smoke test reveals nothing of concern. You decide to deploy the new feature branch to a fresh staging environment for further tests to be run. A quick &quot;eb deploy&quot; command triggers a new test environment to be built and the new container image (identical to the one running on your laptop) to be spun up. Happy that the new application version is working in an environment near-identical to production, you submit a pull request to have the feature branch merged into master and an automated CI/CD workflow (triggered by the commit of merged branch) takes care of the rest.</p>

<h2 id="toc_2">II - Introduction</h2>

<p>This is the first of a multi-part series that demonstrates one solution by which a developer can make the transition of code from laptop to production as pain-free as possible. The fictional semi-automated deployment scenario above is just one solution from a swarming myriad of possible workflows (with varying degrees of automation) that can reduce operational overhead on the developer. This series will make use of technologies such as Git, Docker, Elastic Beanstalk, CircleCI and other standard tools. </p>

<p>In this first article, we will tackle some fundamental building blocks that will allow for more exotic combinations in subsequent articles:</p>

<ol>
<li>Environment setup</li>
<li>Elastic Beanstalk configuration</li>
<li>Manual environment deployment</li>
<li>Deploying a feature release to local container</li>
<li>Transitioning feature release to test Elastic Beanstalk environments</li>
</ol>

<p><strong>Caveat</strong>: The current version of this project (as of 9/27/15) imposes a deliberately simplified example application, release workflow (i.e. no automated tests) and environment layout (just local dev and test) in order to illustrate the key concepts behind running Git, Docker, and Elastic Beanstalk as an integrated unit. Later articles in this series will tackle some more realistic use cases including incorporation in to CICD workflows and more complex applications than run on multiple containers and consume other AWS services.</p>

<p><strong>Disclaimer</strong>: The demonstration code in the corresponding <a href="https://github.com/behemothaur/trinity">repository</a> is for illustrative purposes only, and may not be sufficiently robust for production use. Users should carefully inspect sample code before running in a production environment. Use at your own risk.</p>

<p><strong>Disclosure</strong>: The idea of a Makefile mechanism to automate container preparation, build, push etc. was inspired by <a href="http://victorlin.me/posts/2014/11/26/running-docker-with-aws-elastic-beanstalk">this</a> excellent article by Victor Lin.</p>

<h2 id="toc_3">III - Design Principles</h2>

<p>The following fundamental design principles will be followed during the course of this adventure:</p>

<ol>
<li><strong>Simplicity</strong> - adhere to the principles of <a href="https://en.wikipedia.org/wiki/KISS_principle">KISS</a> and <a href="https://en.wikipedia.org/wiki/Occam&#x27;s_razor">Occam&#39;s Razor</a></li>
<li><strong>Agility</strong> - switching between environments and deploying application releases should at most a single <em>simple</em> shell command</li>
<li><strong>Immutability</strong> -  application container images will be considered as immutable. This will eliminate runtime dependency issues when deploying applications across environments. The local development runtime environment should thus be very close to production. </li>
<li><strong>Automation</strong> - Nirvana will be fully automated deployment of application releases triggered by Git workflow events</li>
</ol>

<p>NOTE: Strictly speaking the kernel and container supporting services <em>could</em> differ between hosts however the impact on most applications would be minimal given that most dependencies exist within the runtime environment.</p>

<h2 id="toc_4">IV Prerequisites</h2>

<p>This series of articles and corresponding demonstration code has some dependencies on local environment and accounts with Docker, Github and AWS. You will need the following:</p>

<ol>
<li>Ruby and Python interpreters</li>
<li>Unix &quot;Make&quot; utility</li>
<li>Elastic Beanstalk CLI tools (eb-cli)</li>
<li>Local Git binaries</li>
<li>AWS Account with default Public/Private/NAT VPC configured</li>
<li>AWS IAM user with appropriate policy set</li>
<li>Github account</li>
<li>DockerHub account</li>
<li>Local Docker host (e.g. via Docker Toolbox for OS X)</li>
</ol>

<h2 id="toc_5">V - Demonstration</h2>

<p>NOTE: Rather than start with the details on how to set this up in your own environment, I decided to move that stuff to Appendices that follow and dive straight into the demonstration. In order to replicate the demonstration, the reader will need to have successfully installed &amp; configured the dependencies as per Appendix A, and setup a local environment as per Appendix B.</p>

<h3 id="toc_6">Setting the scene</h3>

<p>Your latest application version is running in production, as a quick check with &quot;eb status&quot; confirms:</p>

<pre class="line-numbers"><code class="language-bash">~/trinity/master&gt; eb status

Environment details for: trinity-prod
  Application name: trinity
  Region: us-west-2
  Deployed Version: v1_1-1-g5bf2
  Environment ID: e-pi9ycc8gfs
  Platform: 64bit Amazon Linux 2015.03 v2.0.2 running Docker 1.7.1
  Tier: WebServer-Standard
  CNAME: trinity-prod-vw9hejjzuh.elasticbeanstalk.com
  Updated: 2015-09-28 01:14:36.798000+00:00
  Status: Ready
  Health: Green
  
~/trinity/master&gt;</code></pre>

<p>You decide to take a look in your browser, using the &quot;eb open&quot; command:</p>

<pre class="line-numbers"><code class="language-bash">~/trinity/master&gt; eb open</code></pre>

<p><img src="https://s3-us-west-2.amazonaws.com/dirigible-images/trinity-prod.png" alt="Prod"></p>

<h3 id="toc_7">New &quot;feature&quot; request</h3>

<hr>

<p>It seems that some extra-terrestrial users (close acquaintances of HAL, I am led to believe) took offense at the rather limited scope of the greeting and made complaints to customer service team. A Github issue (#1 no less) was raised to this effect and you were assigned.</p>

<h3 id="toc_8">Start work in feature branch</h3>

<hr>

<p>Eager to put this issue to bed, you create a feature branch and start work immediately:</p>

<pre class="line-numbers"><code class="language-bash">~/trinity/master&gt; git checkout -b issue-001 master
Switched to a new branch &#39;issue-001&#39;</code></pre>

<p>You make the necessary changes to app.rb and commit:</p>

<pre class="line-numbers"><code class="language-bash">~/trinity/issue-001&gt; git commit -a -m &quot;Fixed #1 - Greeting message scope offensive to extra-terrestrials&quot;
[issue-001 76f9252] Fixed #1 - Greeting message scope offensive to extra-terrestrials
 1 file changed, 1 insertion(+), 1 deletion(-)</code></pre>

<h3 id="toc_9">Create new application container</h3>

<hr>

<p>Since this is a Dockerized application, you can create a new container image and test this image locally before pushing to remote staging environment. A simple &quot;make&quot; is all that is required to build the container and push to Docker hub:</p>

<pre class="line-numbers"><code class="language-bash">~/trinity/issue-001&gt; make
./Docker/build_dockerrun.sh &gt; Dockerrun.aws.json
git archive -o Docker/trinity.tar HEAD
docker build -t djrut/trinity:`git describe --tags` --rm Docker
Sending build context to Docker daemon 3.608 MB
Step 0 : FROM ruby:slim
 ---&gt; c80da6b5b71b
Step 1 : MAINTAINER Duncan Rutland &lt;duncan.rutland@gmail.com&gt;
 ---&gt; Using cache
 ---&gt; 0d47bd3b0475
Step 2 : RUN mkdir -p /usr/src/app
 ---&gt; Using cache
 ---&gt; 04d15bc0ba0e
 
[...SNIP...]

~/trinity/issue-001&gt; </code></pre>

<h3 id="toc_10">Test new application container locally</h3>

<hr>

<p>Now that we have a new Docker image containing the recent commit, let&#39;s first perform a quick test on our local Docker host using the eb-cli tool &quot;eb local run&quot; command to spin-up the new container:</p>

<pre class="line-numbers"><code class="language-bash">~/trinity/issue-001&gt; eb local run
v1.1-2-g76f9252: Pulling from djrut/trinity
843e2bded498: Already exists
[...SNIP...]
8ea23fed0e62: Already exists
Digest: sha256:7429729815fde70daebc9771b5fefabcf30d7a237f567e6f8f983e087935bb72
Status: Image is up to date for djrut/trinity:v1.1-2-g76f9252
Sending build context to Docker daemon 3.598 MB
Step 0 : FROM djrut/trinity:v1.1-2-g76f9252
 ---&gt; 8ea23fed0e62
Step 1 : EXPOSE 80
 ---&gt; Running in aae0380604b1
 ---&gt; 36c175746264
Removing intermediate container aae0380604b1
Successfully built 36c175746264
[2015-09-28 02:50:05] INFO  WEBrick 1.3.1
[2015-09-28 02:50:05] INFO  ruby 2.2.3 (2015-08-18) [x86_64-linux]
== Sinatra (v1.4.6) has taken the stage on 80 for development with backup from WEBrick
[2015-09-28 02:50:05] INFO  WEBrick::HTTPServer#start: pid=1 port=80
...</code></pre>

<p>You open a browser window and connect to the Docker host IP and port that is running the new application version (in this case, http://192.168.99.100/):</p>

<p><img src="https://s3-us-west-2.amazonaws.com/dirigible-images/trinity-local.png" alt="Local"></p>

<p>Success! The new greeting message is working as expected. The next step is to run the new container images in a true AWS test environment to see how this would work in production.</p>

<h3 id="toc_11">Test new application container in test environment</h3>

<hr>

<p>A simple &quot;eb create&quot; command is all that is needed to bind this branch (using the --branch_default option) and spin-up this new version into a fresh staging environment in your accounts default VPC:</p>

<pre class="line-numbers"><code class="language-bash">~/trinity/issue-001&gt; eb create trinity-test-001 --branch_default</code></pre>

<p>This time the &quot;eb open&quot; command can be run to fire up a browser window pointing to the test environment:</p>

<pre class="line-numbers"><code class="language-bash">~/trinity/issue-001&gt; eb open</code></pre>

<p>...and voila! The new application image is running successfully in staging.</p>

<p><img src="https://s3-us-west-2.amazonaws.com/dirigible-images/trinity-test.png" alt="Test"></p>

<p>NOTE: For longer running branches (such as those that wrap entire versions/milestones), this staging environment is persistent and only requires an &quot;eb deploy&quot; to push newer versions, after committing changes and running &quot;make&quot;. </p>

<h2 id="toc_12">Conclusion</h2>

<p>During this demonstration, we examined a simplified use-case that enabled a simple and agile deployment mechanism with immutable application containers. The developer was able to use three simple shell commands &quot;commit&quot;, &quot;make&quot; and &quot;eb deploy&quot; to build a new immutable container &amp; push to the appropriate environment. This approach dramatically reduced the likelihood of broken dependencies as application releases are progressed from developer laptop onto to staging and production.</p>

<p>In <strong>Part II</strong> of this series we will take a peek under the covers to examine how we integrated Docker, Elastic Beanstalk and Git to enable the simple example above.</p>

<p>In <strong>Part III</strong>, we will make this look closer to a real production scenario by adding some additional components (and external dependencies) to the application and introduce unit tests.</p>

<p>In <strong>Part IV</strong>, we will show how this application can integrate into a fully automated CI/CD workflow using CircleCI.</p>

<p>Thank-you for your time and attention!</p>

<hr>

<h2 id="toc_13">Appendix A - Dependencies</h2>

<p>The following section outlines the steps needed to setup a local environment on Max OS X.</p>

<h3 id="toc_14">Install Homebrew</h3>

<pre class="line-numbers"><code class="language-bash">ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot;</code></pre>

<h3 id="toc_15">Install Python</h3>

<pre class="line-numbers"><code class="language-bash">sudo brew install python</code></pre>

<h3 id="toc_16">Install eb-cli</h3>

<pre class="line-numbers"><code class="language-bash">sudo pip install eb-cli</code></pre>

<h3 id="toc_17">Install Docker Toolbox</h3>

<p>Follow the instructions <a href="https://docs.docker.com/installation/mac/">here</a> to install and configure Docker host running in a VirtualBox VM on OS X.</p>

<p>NOTE: <em>I had issues with connectivity to the host starting after initial install (I was getting &quot;no route to host&quot;). After some troubleshooting, this was remedied by a restart of OS X. It is not necessary, as some older issues relating to this problem indicate, to create manual NAT table entries</em></p>

<h3 id="toc_18">Setup Git</h3>

<p>Most modern Unix variants will have the git package already installed. Follow the instructions <a href="https://help.github.com/articles/set-up-git/">here</a> to setup Git. There are some useful instructions <a href="https://help.github.com/articles/caching-your-github-password-in-git/">here</a> to setup credential caching to avoid having to frequently re-type your credentials. </p>

<h3 id="toc_19">Configure AWS credentials</h3>

<p>My preferred approach is to populate the .aws/credentials file as follows:</p>

<pre class="line-numbers"><code class="language-bash">[default]
aws_access_key_id = [ACCESS KEY]
aws_secret_access_key =  [SECRET]</code></pre>

<p>You will need an IAM role assigned to this user or containing group that has adequate permissions to IAM, EB, EC2, S3 etc... Since this is my playground account I used a wide open admin policy:</p>

<pre class="line-numbers"><code class="language-none">{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Action&quot;: &quot;*&quot;,
      &quot;Resource&quot;: &quot;*&quot;
    }
  ]
}</code></pre>

<p>Caveat: This IAM policy is <strong>not</strong> recommended for production use, which should utilize a fine-grained IAM policy.</p>

<h2 id="toc_20">Appendix B - Environment Setup</h2>

<p>There are number steps involved here to get the environment setup, but remember that these are <em>one time</em> actions that you will not need to repeat again unless you need to recreate the environment again from scratch.</p>

<h3 id="toc_21">Step 1 - Choose a name for your application</h3>

<p>It will be necessary to create a unique name for your forked version of the trinity application. This is required since Elastic Beanstalk DNS CNAME records must be globally unique. We shall refer to this name as <em>APP_NAME</em> henceforth. </p>

<h3 id="toc_22">Step 2 - Fork &amp; clone Git repository</h3>

<p>The first step is to fork and clone the demo Git repository. Full details on how do to this can be found <a href="https://help.github.com/articles/fork-a-repo/">here</a> however the basic steps are:</p>

<ol>
<li>On GitHub, navigate to the <a href="https://github.com/behemothaur/trinity">behemothaur/trinity</a> repository </li>
<li>In the top-right corner of the page, click <strong>Fork</strong>. You now have a fork of the demo repository in your Github account.</li>
<li>Create local clone, substituting your Github USERNAME</li>
</ol>

<pre class="line-numbers"><code class="language-bash">git clone https://github.com/[USER_NAME]/trinity.git</code></pre>

<ol>
<li>Create upstream repository to allow sync with original project</li>
</ol>

<pre class="line-numbers"><code class="language-bash">git remote add upstream https://github.com/behemothaur/trinity.git</code></pre>

<h3 id="toc_23">Step 2 - Docker Hub setup</h3>

<ol>
<li>Create a Docker Hub account and create a repository for <em>APP_NAME</em></li>
<li>Edit &quot;Makefile&quot;</li>
<li>Substitute USER value (currently set to &quot;djrut&quot;) with your Docker Hub username.</li>
<li>Substitute REPO value (currently set to &quot;trinity&quot;) with your newly created <em>APP_NAME</em></li>
<li>Login to Docker hub (this will permanently store your Docker Hub credentials in ~/.docker/config.json)</li>
</ol>

<pre class="line-numbers"><code class="language-bash">docker login</code></pre>

<h3 id="toc_24">Step 3 - Initialize Elastic Beanstalk environments</h3>

<p>NOTE: This step requires that you either have a default VPC configured with public/private NAT configuration <em>or</em> you explicitly specify the VPC and subnet IDs during Elastic Beanstalk environment configuration step. I will be using the latter mechanism to supply a previously saved configuration to the &quot;eb create&quot; command.</p>

<h4 id="toc_25">a) Initialize the Elastic Beanstalk Application</h4>

<pre class="line-numbers"><code class="language-bash">eb init [APP_NAME] --region us-west-2 --platform &quot;Docker 1.7.1&quot;</code></pre>

<p>Upon success you should a message like &quot;Application [APP_NAME] has been created.&quot;</p>

<h4 id="toc_26">b) Create &quot;production&quot; Elastic Beanstalk environment</h4>

<p>Ensure that you are currently in the up-to-date &quot;master&quot; branch of the application:</p>

<pre class="line-numbers"><code class="language-bash">prompt&gt; git status
On branch master
Your branch is up-to-date with &#39;origin/master&#39;.
nothing to commit, working directory clean </code></pre>

<p>Run the &quot;eb create&quot; substituting <em>APP_NAME</em> for your application name:</p>

<pre class="line-numbers"><code class="language-bash">eb create [APP_NAME]-prod --branch_default</code></pre>

<p>You should now see a trail of events as Elastic Beanstalk launches the environment. Here is a snippet from mine:</p>

<pre class="line-numbers"><code class="language-bash">Creating application version archive &quot;v1_1&quot;.
Uploading trinity/v1_1.zip to S3. This may take a while.
Upload Complete.
Environment details for: trinity-prod
  Application name: trinity
  Region: us-west-2
  Deployed Version: v1_1
  Environment ID: e-pi9ycc8gfs
  Platform: 64bit Amazon Linux 2015.03 v2.0.2 running Docker 1.7.1
  Tier: WebServer-Standard
  CNAME: UNKNOWN
  Updated: 2015-09-27 19:24:42.760000+00:00
Printing Status:
INFO: createEnvironment is starting.
INFO: Using elasticbeanstalk-us-west-2-852112010953 as Amazon S3 storage bucket for environment data.
INFO: Created security group named: sg-d47aebb0
INFO: Created load balancer named: awseb-e-p-AWSEBLoa-XUW9PIDWF5JH
INFO: Created security group named: sg-d27aebb6
INFO: Created Auto Scaling launch configuration named: awseb-e-pi9ycc8gfs-stack-AWSEBAutoScalingLaunchConfiguration-1SUHKGKXB0C01
INFO: Environment health has transitioned to Pending. There are no instances.
INFO: Added instance [i-7b176ca0] to your environment.
INFO: Waiting for EC2 instances to launch. This may take a few minutes.</code></pre>

<p>At this stage you can safely CTRL-C and wait a few minutes for the environment to be spun up. This takes longer for the first deployment since the full Docker image needs to be downloaded. Subsequent deployments of newer versions of the application will be faster since only the modified layers of the image need to be downloaded.</p>

<p>You can check periodically with &quot;eb status&quot; and wait for &quot;Health: Green&quot; to indicate that all is well:</p>

<pre class="line-numbers"><code class="language-bash">prompt&gt; eb status
Environment details for: trinity-prod
  Application name: trinity
  Region: us-west-2
  Deployed Version: v1_1
  Environment ID: e-pi9ycc8gfs
  Platform: 64bit Amazon Linux 2015.03 v2.0.2 running Docker 1.7.1
  Tier: WebServer-Standard
  CNAME: trinity-prod-vw9hejjzuh.elasticbeanstalk.com
  Updated: 2015-09-27 19:32:43.591000+00:00
  Status: Ready
  Health: Green</code></pre>

<p>Finally, there is a handy command &quot;eb open&quot; that will open the current environment in your browser for a quick eye test:</p>

<pre class="line-numbers"><code class="language-bash">eb open</code></pre>

<script type="text/javascript">
var _self="undefined"!=typeof window?window:"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?self:{},Prism=function(){var e=/\blang(?:uage)?-(?!\*)(\w+)\b/i,t=_self.Prism={util:{encode:function(e){return e instanceof n?new n(e.type,t.util.encode(e.content),e.alias):"Array"===t.util.type(e)?e.map(t.util.encode):e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/\u00a0/g," ")},type:function(e){return Object.prototype.toString.call(e).match(/\[object (\w+)\]/)[1]},clone:function(e){var n=t.util.type(e);switch(n){case"Object":var a={};for(var r in e)e.hasOwnProperty(r)&&(a[r]=t.util.clone(e[r]));return a;case"Array":return e.map&&e.map(function(e){return t.util.clone(e)})}return e}},languages:{extend:function(e,n){var a=t.util.clone(t.languages[e]);for(var r in n)a[r]=n[r];return a},insertBefore:function(e,n,a,r){r=r||t.languages;var i=r[e];if(2==arguments.length){a=arguments[1];for(var l in a)a.hasOwnProperty(l)&&(i[l]=a[l]);return i}var o={};for(var s in i)if(i.hasOwnProperty(s)){if(s==n)for(var l in a)a.hasOwnProperty(l)&&(o[l]=a[l]);o[s]=i[s]}return t.languages.DFS(t.languages,function(t,n){n===r[e]&&t!=e&&(this[t]=o)}),r[e]=o},DFS:function(e,n,a){for(var r in e)e.hasOwnProperty(r)&&(n.call(e,r,e[r],a||r),"Object"===t.util.type(e[r])?t.languages.DFS(e[r],n):"Array"===t.util.type(e[r])&&t.languages.DFS(e[r],n,r))}},highlightAll:function(e,n){for(var a,r=document.querySelectorAll('code[class*="language-"], [class*="language-"] code, code[class*="lang-"], [class*="lang-"] code'),i=0;a=r[i++];)t.highlightElement(a,e===!0,n)},highlightElement:function(a,r,i){for(var l,o,s=a;s&&!e.test(s.className);)s=s.parentNode;s&&(l=(s.className.match(e)||[,""])[1],o=t.languages[l]),a.className=a.className.replace(e,"").replace(/\s+/g," ")+" language-"+l,s=a.parentNode,/pre/i.test(s.nodeName)&&(s.className=s.className.replace(e,"").replace(/\s+/g," ")+" language-"+l);var u=a.textContent,c={element:a,language:l,grammar:o,code:u};if(u&&(c.code=u.replace(/^(?:\r?\n|\r)/,"")),!u||!o)return t.hooks.run("complete",c),void 0;if(t.hooks.run("before-highlight",c),r&&_self.Worker){var g=new Worker(t.filename);g.onmessage=function(e){c.highlightedCode=n.stringify(JSON.parse(e.data),l),t.hooks.run("before-insert",c),c.element.innerHTML=c.highlightedCode,i&&i.call(c.element),t.hooks.run("after-highlight",c),t.hooks.run("complete",c)},g.postMessage(JSON.stringify({language:c.language,code:c.code}))}else c.highlightedCode=t.highlight(c.code,c.grammar,c.language),t.hooks.run("before-insert",c),c.element.innerHTML=c.highlightedCode,i&&i.call(a),t.hooks.run("after-highlight",c),t.hooks.run("complete",c)},highlight:function(e,a,r){var i=t.tokenize(e,a);return n.stringify(t.util.encode(i),r)},tokenize:function(e,n){var a=t.Token,r=[e],i=n.rest;if(i){for(var l in i)n[l]=i[l];delete n.rest}e:for(var l in n)if(n.hasOwnProperty(l)&&n[l]){var o=n[l];o="Array"===t.util.type(o)?o:[o];for(var s=0;s<o.length;++s){var u=o[s],c=u.inside,g=!!u.lookbehind,f=0,h=u.alias;u=u.pattern||u;for(var p=0;p<r.length;p++){var d=r[p];if(r.length>e.length)break e;if(!(d instanceof a)){u.lastIndex=0;var m=u.exec(d);if(m){g&&(f=m[1].length);var y=m.index-1+f,m=m[0].slice(f),v=m.length,k=y+v,b=d.slice(0,y+1),w=d.slice(k+1),N=[p,1];b&&N.push(b);var O=new a(l,c?t.tokenize(m,c):m,h);N.push(O),w&&N.push(w),Array.prototype.splice.apply(r,N)}}}}}return r},hooks:{all:{},add:function(e,n){var a=t.hooks.all;a[e]=a[e]||[],a[e].push(n)},run:function(e,n){var a=t.hooks.all[e];if(a&&a.length)for(var r,i=0;r=a[i++];)r(n)}}},n=t.Token=function(e,t,n){this.type=e,this.content=t,this.alias=n};if(n.stringify=function(e,a,r){if("string"==typeof e)return e;if("Array"===t.util.type(e))return e.map(function(t){return n.stringify(t,a,e)}).join("");var i={type:e.type,content:n.stringify(e.content,a,r),tag:"span",classes:["token",e.type],attributes:{},language:a,parent:r};if("comment"==i.type&&(i.attributes.spellcheck="true"),e.alias){var l="Array"===t.util.type(e.alias)?e.alias:[e.alias];Array.prototype.push.apply(i.classes,l)}t.hooks.run("wrap",i);var o="";for(var s in i.attributes)o+=s+'="'+(i.attributes[s]||"")+'"';return"<"+i.tag+' class="'+i.classes.join(" ")+'" '+o+">"+i.content+"</"+i.tag+">"},!_self.document)return _self.addEventListener?(_self.addEventListener("message",function(e){var n=JSON.parse(e.data),a=n.language,r=n.code;_self.postMessage(JSON.stringify(t.util.encode(t.tokenize(r,t.languages[a])))),_self.close()},!1),_self.Prism):_self.Prism;var a=document.getElementsByTagName("script");return a=a[a.length-1],a&&(t.filename=a.src,document.addEventListener&&!a.hasAttribute("data-manual")&&document.addEventListener("DOMContentLoaded",t.highlightAll)),_self.Prism}();"undefined"!=typeof module&&module.exports&&(module.exports=Prism);
</script>
<script type="text/javascript">
Prism.languages.clike={comment:[{pattern:/(^|[^\\])\/\*[\w\W]*?\*\//,lookbehind:!0},{pattern:/(^|[^\\:])\/\/.*/,lookbehind:!0}],string:/("|')(\\(?:\r\n|[\s\S])|(?!\1)[^\\\r\n])*\1/,"class-name":{pattern:/((?:(?:class|interface|extends|implements|trait|instanceof|new)\s+)|(?:catch\s+\())[a-z0-9_\.\\]+/i,lookbehind:!0,inside:{punctuation:/(\.|\\)/}},keyword:/\b(if|else|while|do|for|return|in|instanceof|function|new|try|throw|catch|finally|null|break|continue)\b/,"boolean":/\b(true|false)\b/,"function":/[a-z0-9_]+(?=\()/i,number:/\b-?(0x[\dA-Fa-f]+|\d*\.?\d+([Ee]-?\d+)?)\b/,operator:/[-+]{1,2}|!|<=?|>=?|={1,3}|&{1,2}|\|?\||\?|\*|\/|~|\^|%/,punctuation:/[{}[\];(),.:]/};
</script>
<script type="text/javascript">
Prism.languages.bash=Prism.languages.extend("clike",{comment:{pattern:/(^|[^"{\\])#.*/,lookbehind:!0},string:{pattern:/("|')(\\?[\s\S])*?\1/,inside:{property:/\$([a-zA-Z0-9_#\?\-\*!@]+|\{[^\}]+\})/}},number:{pattern:/([^\w\.])-?(0x[\dA-Fa-f]+|\d*\.?\d+([Ee]-?\d+)?)\b/,lookbehind:!0},"function":/\b(?:alias|apropos|apt-get|aptitude|aspell|awk|basename|bash|bc|bg|builtin|bzip2|cal|cat|cd|cfdisk|chgrp|chmod|chown|chroot|chkconfig|cksum|clear|cmp|comm|command|cp|cron|crontab|csplit|cut|date|dc|dd|ddrescue|df|diff|diff3|dig|dir|dircolors|dirname|dirs|dmesg|du|egrep|eject|enable|env|ethtool|eval|exec|expand|expect|export|expr|fdformat|fdisk|fg|fgrep|file|find|fmt|fold|format|free|fsck|ftp|fuser|gawk|getopts|git|grep|groupadd|groupdel|groupmod|groups|gzip|hash|head|help|hg|history|hostname|htop|iconv|id|ifconfig|ifdown|ifup|import|install|jobs|join|kill|killall|less|link|ln|locate|logname|logout|look|lpc|lpr|lprint|lprintd|lprintq|lprm|ls|lsof|make|man|mkdir|mkfifo|mkisofs|mknod|more|most|mount|mtools|mtr|mv|mmv|nano|netstat|nice|nl|nohup|notify-send|nslookup|open|op|passwd|paste|pathchk|ping|pkill|popd|pr|printcap|printenv|printf|ps|pushd|pv|pwd|quota|quotacheck|quotactl|ram|rar|rcp|read|readarray|readonly|reboot|rename|renice|remsync|rev|rm|rmdir|rsync|screen|scp|sdiff|sed|seq|service|sftp|shift|shopt|shutdown|sleep|slocate|sort|source|split|ssh|stat|strace|su|sudo|sum|suspend|sync|tail|tar|tee|test|time|timeout|times|touch|top|traceroute|trap|tr|tsort|tty|type|ulimit|umask|umount|unalias|uname|unexpand|uniq|units|unrar|unshar|uptime|useradd|userdel|usermod|users|uuencode|uudecode|v|vdir|vi|vmstat|wait|watch|wc|wget|whereis|which|who|whoami|write|xargs|xdg-open|yes|zip)\b/,keyword:/\b(if|then|else|elif|fi|for|break|continue|while|in|case|function|select|do|done|until|echo|exit|return|set|declare)\b/}),Prism.languages.insertBefore("bash","keyword",{property:/\$([a-zA-Z0-9_#\?\-\*!@]+|\{[^}]+\})/}),Prism.languages.insertBefore("bash","comment",{important:/^#!\s*\/bin\/bash|^#!\s*\/bin\/sh/});
</script>
<script type="text/javascript">
Prism.hooks.add("complete",function(e){if(e.code){var t=e.element.parentNode,s=/\s*\bline-numbers\b\s*/;if(t&&/pre/i.test(t.nodeName)&&(s.test(t.className)||s.test(e.element.className))&&!e.element.querySelector(".line-numbers-rows")){s.test(e.element.className)&&(e.element.className=e.element.className.replace(s,"")),s.test(t.className)||(t.className+=" line-numbers");var a,n=1+e.code.split("\n").length,l=new Array(n);l=l.join("<span></span>"),a=document.createElement("span"),a.className="line-numbers-rows",a.innerHTML=l,t.hasAttribute("data-start")&&(t.style.counterReset="linenumber "+(parseInt(t.getAttribute("data-start"),10)-1)),e.element.appendChild(a)}}});
</script>
<script type="text/javascript">
!function(){if(self.Prism){var e={csharp:"C#",cpp:"C++"};Prism.hooks.add("before-highlight",function(a){var t=a.element.parentNode;if(t&&/pre/i.test(t.nodeName)){var i=e[a.language]||a.language;t.setAttribute("data-language",i)}})}}();
</script>
</body>

</html>
